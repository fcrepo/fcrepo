
jobs:
  include:
    - name: Build - Linux
      os: linux
      dist: trusty
      sudo: true
      language: java
      jdk: openjdk11
      env: DEPLOY=true
    - name: Build - Windows
      os: windows
      language: shell
    - name: ITests - PostgreSQL
      os: linux
      dist: xenial
      sudo: true
      language: java
      jdk: openjdk11
      addons:
        postgresql: '12'
        "apt": {
          "packages": [
            "postgresql-12",
            "postgresql-client-12"
          ]
        }
      before_script:
        - psql -c 'CREATE DATABASE fcrepo;' -U postgres
      script:
        - ./mvnw -Dfcrepo.db.url="jdbc:postgresql://localhost:5432/fcrepo" -Dfcrepo.db.user="postgres" -Dfcrepo.db.password="" clean install -P db-tests
    - name: ITests - MariaDB
      os: linux
      dist: trusty
      sudo: true
      language: java
      jdk: openjdk11
      addons:
        mariadb: "10.4"
      before_script:
        - mysql -e 'CREATE DATABASE IF NOT EXISTS fcrepo;'
      script:
        - ./mvnw -Dfcrepo.db.url="jdbc:mariadb://localhost:3306/fcrepo" -Dfcrepo.db.user="travis" -Dfcrepo.db.password="" clean install -P db-tests
    - name: ITests - MySQL
      os: linux
      dist: xenial
      sudo: true
      language: java
      jdk: openjdk11
      services:
        - mysql
      before_script:
        - wget https://repo.mysql.com//mysql-apt-config_0.8.10-1_all.deb
        - sudo dpkg -i mysql-apt-config_0.8.10-1_all.deb
        - sudo apt-get update -q
        - sudo apt-get install -q -y --allow-unauthenticated -o Dpkg::Options::=--force-confnew mysql-server
        - sudo systemctl restart mysql
        - sudo mysql_upgrade
        - mysql --version
        - mysql -e 'CREATE DATABASE IF NOT EXISTS fcrepo;'
      script:
        - ./mvnw -Dfcrepo.db.url="jdbc:mysql://localhost:3306/fcrepo" -Dfcrepo.db.user="travis" -Dfcrepo.db.password="" clean install  -P db-tests

env:
  - MAVEN_VERSION=3.6.3

before_install:
 - if [ "$TRAVIS_OS_NAME" = "windows" ]; then
    choco install openjdk11 --version 11.0.5.10;
    export JAVA_HOME='/c/Program Files/OpenJDK/openjdk-11.0.5_10'
    export PATH="${PATH}:${JAVA_HOME}/bin";
    choco install maven --version ${MAVEN_VERSION};
    export PATH="${PATH}:/c/ProgramData/chocolatey/lib/maven/apache-maven-3.6.3/bin";
  fi;
 - "echo $PATH"
 - "export JAVA_OPTS=-Xmx512m"
 - "mvn -N io.takari:maven:0.7.7:wrapper -Dmaven=${MAVEN_VERSION}"
 - if [ "$TRAVIS_OS_NAME" = "linux" ] && [ ! -z "$GPG_SECRET_KEYS" ] [ ! -z "$GPG_SECRET_KEYS" ]; then echo $GPG_SECRET_KEYS | base64 --decode | $GPG_EXECUTABLE --import; fi
 - if [ "$TRAVIS_OS_NAME" = "linux" ] && [ ! -z "$GPG_OWNERTRUST" ]; then echo $GPG_OWNERTRUST | base64 --decode | $GPG_EXECUTABLE --import-ownertrust; fi

# Default installation command is 
# mvn install -DskipTests=true -Dmaven.javadoc.skip=true -B -V
# this is what we test as our build phase so skip it here.
install:
 - true

before_script:
 - if [ "$TRAVIS_OS_NAME" = "linux" ]; then 
     sudo service mysql stop;
     sudo service postgresql stop;
     sudo service acpid stop;
     sudo service atd stop;
     sudo service cron stop;
     sudo service memcached stop;
     sudo service ntp stop;
     sudo service rabbitmq-server stop;
     sudo service resolvconf stop;
     sudo service sshguard stop;
     sudo service ssh stop;
   fi
    
script:
 - ./mvnw --settings .travis/settings.xml -Dgpg.skip -Dfcrepo.streaming.parallel=true install -B -V

deploy:
 -
   provider: script
   script: .travis/deploy.sh
   skip_cleanup: true
   on:
     repo: fcrepo4/fcrepo4
     branch: main 
     condition: $DEPLOY = true

notifications:
  irc: "irc.freenode.org#fcrepo"
  email:
      - fedora-tech@googlegroups.com
